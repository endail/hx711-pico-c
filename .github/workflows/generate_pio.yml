name: Generate PIO header

on: [push, workflow_dispatch]

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
        with:
          ref: ${{ github.ref }}
      - uses: actions/setup-node@v3
        with:
          node-version: 16
      - run: |

          npm install --save pioasm@2.0.0;

          node --input-type=module -e '
          
            import { PIOAssembler } from "pioasm";
            import fs from "fs";

            const source = fs.readFileSync(
              "src/hx711_noblock.pio",
              "utf8");

            const pioasm = new PIOAssembler();

            const header = "// THIS FILE IS AUTOGENERATED BY GITHUB ACTIONS\n" +
            "// YOU SHOULD #include THIS FILE\n" +
            "// THE /src/hx711_noblock.pio IS NOT USABLE UNLESS\n" +
            "// YOU CONVERT IT USING pioasm\n" +
            "// SEE: /.github/workflows/generate_pio.yml";

            pioasm.assemble(source).then(result => {
                fs.writeFileSync(
                  "include/hx711_noblock.pio.h",
                  header + "\n\n" + result.output,
                  null,
                  "utf8");
            });

          ';

          if git status --porcelain | grep include/hx711_noblock.pio.h; then
            git config --global user.name "github-actions[bot]";
            git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com";
            git commit -am "auto-generate PIO header";
            git push;
          else
            echo no changes
          fi
