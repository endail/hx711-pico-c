name: Generate PIO header

on: [push, workflow_dispatch]

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
        with:
          ref: ${{ github.ref }}
      - uses: actions/setup-node@v3
        with:
          node-version: 16
      - run: |

          npm install --save pioasm@2.0.0;
          npm install --save glob;

          node --input-type=module -e '
          
            import { PIOAssembler } from "pioasm";
            import fs from "fs";
            import glob from "glob";

            glob("src/*.pio", {}, function(err, files) {
              files.forEach(function(f) {

                const source = fs.readFileSync(f, "utf8");
                const pioasm = new PIOAssembler();

                const header = "// THIS FILE IS AUTOGENERATED BY GITHUB ACTIONS\n" +
                  "// YOU SHOULD #include THIS FILE\n" +
                  "// THE " + f + " file IS NOT USABLE UNLESS\n" +
                  "// YOU CONVERT IT USING pioasm\n" +
                  "// SEE: /.github/workflows/generate_pio.yml";

                pioasm.assemble(source).then(result => {
                  const writePath = "include/" + path.basename(f) + ".h";
                  const writeText = header + "\n\n" + result.output;
                  fs.writeFileSync(writePath, writeText, null, "utf8");
                });

              });
            });

          ';

          git update-index --refresh;

          if git diff-index --quiet HEAD --; then
            git config --global user.name "github-actions[bot]";
            git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com";
            git commit -am "auto-generate PIO header(s)";
            git push;
          else
            echo no changes
          fi
