<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>hx711-pico-c: hx711-pico-c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">hx711-pico-c
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('index.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">hx711-pico-c </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_README"></a> This is my implementation of reading from a HX711 via a Raspberry Pi Pico. It uses the RP2040's PIO feature to be as efficient as possible.</p>
<p>A MicroPython port is available <a href="https://github.com/endail/hx711-pico-mpy">here</a>.</p>
<p><b>NOTE</b>: if you are looking for a method to weigh objects (ie. by using the HX711 as a scale), see <a href="https://github.com/endail/pico-scale">pico-scale</a>.</p>
<p><img src="resources/hx711_serialout.gif" alt="resources/hx711_serialout.gif" class="inline"/></p>
<p>The .gif above illustrates the <a href="main.c">current example code</a> obtaining data from a HX711 operating at 80 samples per second.</p>
<h1><a class="anchor" id="autotoc_md1"></a>
Clone Repository</h1>
<div class="fragment"><div class="line">git clone https://github.com/endail/hx711-pico-c</div>
</div><!-- fragment --><p>Run CTest to build the example program. The <code>.uf2</code> file you upload to your Pico will be found under <code>build/tests/</code>.</p>
<p>Alternatively, include it as a submodule in your project and then <code>#include "extern/hx711-pico-c/include/hx711.h"</code> and <code>#include "extern/hx711-pico-c/include/hx711_noblock.pio.h"</code>.</p>
<div class="fragment"><div class="line">git submodule add https://github.com/endail/hx711-pico-c extern/hx711-pico-c</div>
<div class="line">git submodule update --init</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md2"></a>
Documentation</h1>
<p><a href="https://endail.github.io/hx711-pico-c/hx711_8h.html">https://endail.github.io/hx711-pico-c</a></p>
<h1><a class="anchor" id="autotoc_md3"></a>
How to Use</h1>
<p>See <a href="https://pico.pinout.xyz/">here</a> for a pinout to choose two GPIO pins on the Pico (RP2040). One GPIO pin to connect to the HX711's clock pin and a second GPIO pin to connect to the HX711's data pin. You can choose any two pins as the clock and data pins, as long as they are capable of digital output and input respectively.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="hx711_8h.html">include/hx711.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="hx711__noblock_8pio_8h.html">include/hx711_noblock.pio.h</a>&quot;</span> <span class="comment">// for hx711_noblock_program and hx711_noblock_program_init</span></div>
<div class="line"> </div>
<div class="line"><a class="code" href="structhx711__t.html">hx711_t</a> hx;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// 1. Initialise the HX711</span></div>
<div class="line"><a class="code" href="hx711_8h.html#a20c562c58345b4cb4c8922925ec0a877">hx711_init</a>(</div>
<div class="line">    &amp;hx,</div>
<div class="line">    clkPin, <span class="comment">// Pico GPIO pin connected to HX711&#39;s clock pin</span></div>
<div class="line">    datPin, <span class="comment">// Pico GPIO pin connected to HX711&#39;s data pin</span></div>
<div class="line">    pio0, <span class="comment">// the RP2040 PIO to use (either pio0 or pio1)</span></div>
<div class="line">    &amp;<a class="code" href="hx711__noblock_8pio_8h.html#a116dfe25b456231a2eada965de465101">hx711_noblock_program</a>, <span class="comment">// the state machine program</span></div>
<div class="line">    &amp;<a class="code" href="hx711__noblock_8pio_8h.html#a2a7669554165d3956d65c5f643c022c1">hx711_noblock_program_init</a>); <span class="comment">// the state machine program init function</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">//2. power up the hx711 and use a gain of 128</span></div>
<div class="line"><a class="code" href="hx711_8c.html#af7b303fec0e81c0fbef875216d9f6ea6">hx711_power_up</a>(&amp;hx, <a class="code" href="hx711_8h.html#acadec7365abc52889994131164536304aa9da6f32e4c6b52bf5c07d6670f942e1">hx711_gain_128</a>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">//3. This step is optional. Only do this if you want to</span></div>
<div class="line"><span class="comment">//change the gain AND save it to the HX711 chip</span></div>
<div class="line"><span class="comment">//</span></div>
<div class="line"><span class="comment">//hx711_set_gain(&amp;hx, hx711_gain_64);</span></div>
<div class="line"><span class="comment">//hx711_power_down(&amp;hx);</span></div>
<div class="line"><span class="comment">//hx711_wait_power_down();</span></div>
<div class="line"><span class="comment">//hx711_power_up(&amp;hx, hx711_gain_64);</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// 4. Wait for readings to settle</span></div>
<div class="line"><a class="code" href="hx711_8h.html#a5495b51ec048d8363783a572fb577ecc">hx711_wait_settle</a>(<a class="code" href="hx711_8h.html#aa32021164bb71485f28db91a7c5c776fa40b58161d4eeb9860f339f0309fafa33">hx711_rate_10</a>); <span class="comment">// or hx711_rate_80 depending on your chip&#39;s config</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// 5. Read values</span></div>
<div class="line">int32_t val;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// wait (block) until a value is read</span></div>
<div class="line">val = <a class="code" href="hx711_8h.html#a2a490345d56d3d9f06f809c07446a6e5">hx711_get_value</a>(&amp;hx);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// or use a timeout</span></div>
<div class="line"><span class="keywordflow">if</span>(<a class="code" href="hx711_8h.html#a0ab1a8852812daf235cf743f530cf037">hx711_get_value_timeout</a>(&amp;hx, 250000, &amp;val)) {</div>
<div class="line">    <span class="comment">// value was obtained within the timeout period</span></div>
<div class="line">    <span class="comment">// in this case, within 250 milliseconds</span></div>
<div class="line">    printf(<span class="stringliteral">&quot;%li\n&quot;</span>, val);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// or see if there&#39;s a value, but don&#39;t block if not</span></div>
<div class="line"><span class="keywordflow">if</span>(<a class="code" href="hx711_8h.html#a0c8ff19b682c8518252a5d6ed67d6598">hx711_get_value_noblock</a>(&amp;hx, &amp;val)) {</div>
<div class="line">    printf(<span class="stringliteral">&quot;%li\n&quot;</span>, val);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">//6. Stop communication with HX711</span></div>
<div class="line"><a class="code" href="hx711_8h.html#a430408c58853bd2ec9b4e2bacb36f055">hx711_close</a>(&amp;hx);</div>
<div class="ttc" id="ahx711_8c_html_af7b303fec0e81c0fbef875216d9f6ea6"><div class="ttname"><a href="hx711_8c.html#af7b303fec0e81c0fbef875216d9f6ea6">hx711_power_up</a></div><div class="ttdeci">void hx711_power_up(hx711_t *const hx, const hx711_gain_t gain)</div><div class="ttdef"><b>Definition:</b> <a href="hx711_8c_source.html#l00269">hx711.c:269</a></div></div>
<div class="ttc" id="ahx711_8h_html"><div class="ttname"><a href="hx711_8h.html">hx711.h</a></div></div>
<div class="ttc" id="ahx711_8h_html_a0ab1a8852812daf235cf743f530cf037"><div class="ttname"><a href="hx711_8h.html#a0ab1a8852812daf235cf743f530cf037">hx711_get_value_timeout</a></div><div class="ttdeci">bool hx711_get_value_timeout(hx711_t *const hx, const uint timeout, int32_t *const val)</div><div class="ttdoc">Obtains a value from the HX711. Blocks until a value is available or the timeout is reached.</div><div class="ttdef"><b>Definition:</b> <a href="hx711_8c_source.html#l00213">hx711.c:213</a></div></div>
<div class="ttc" id="ahx711_8h_html_a0c8ff19b682c8518252a5d6ed67d6598"><div class="ttname"><a href="hx711_8h.html#a0c8ff19b682c8518252a5d6ed67d6598">hx711_get_value_noblock</a></div><div class="ttdeci">bool hx711_get_value_noblock(hx711_t *const hx, int32_t *const val)</div><div class="ttdoc">Obtains a value from the HX711. Returns immediately if no value is available.</div><div class="ttdef"><b>Definition:</b> <a href="hx711_8c_source.html#l00245">hx711.c:245</a></div></div>
<div class="ttc" id="ahx711_8h_html_a20c562c58345b4cb4c8922925ec0a877"><div class="ttname"><a href="hx711_8h.html#a20c562c58345b4cb4c8922925ec0a877">hx711_init</a></div><div class="ttdeci">void hx711_init(hx711_t *const hx, const uint clk, const uint dat, PIO const pio, const pio_program_t *const prog, hx711_program_init_t prog_init_func)</div><div class="ttdoc">Initialise HX711.</div><div class="ttdef"><b>Definition:</b> <a href="hx711_8c_source.html#l00026">hx711.c:26</a></div></div>
<div class="ttc" id="ahx711_8h_html_a2a490345d56d3d9f06f809c07446a6e5"><div class="ttname"><a href="hx711_8h.html#a2a490345d56d3d9f06f809c07446a6e5">hx711_get_value</a></div><div class="ttdeci">int32_t hx711_get_value(hx711_t *const hx)</div><div class="ttdoc">Obtains a value from the HX711. Blocks until a value is available.</div><div class="ttdef"><b>Definition:</b> <a href="hx711_8c_source.html#l00188">hx711.c:188</a></div></div>
<div class="ttc" id="ahx711_8h_html_a430408c58853bd2ec9b4e2bacb36f055"><div class="ttname"><a href="hx711_8h.html#a430408c58853bd2ec9b4e2bacb36f055">hx711_close</a></div><div class="ttdeci">void hx711_close(hx711_t *const hx)</div><div class="ttdoc">Stop communication with HX711.</div><div class="ttdef"><b>Definition:</b> <a href="hx711_8c_source.html#l00085">hx711.c:85</a></div></div>
<div class="ttc" id="ahx711_8h_html_a5495b51ec048d8363783a572fb577ecc"><div class="ttname"><a href="hx711_8h.html#a5495b51ec048d8363783a572fb577ecc">hx711_wait_settle</a></div><div class="ttdeci">static void hx711_wait_settle(const hx711_rate_t rate)</div><div class="ttdoc">Convenience function for sleeping for the appropriate amount of time according to the given sample ra...</div><div class="ttdef"><b>Definition:</b> <a href="hx711_8h_source.html#l00256">hx711.h:256</a></div></div>
<div class="ttc" id="ahx711_8h_html_aa32021164bb71485f28db91a7c5c776fa40b58161d4eeb9860f339f0309fafa33"><div class="ttname"><a href="hx711_8h.html#aa32021164bb71485f28db91a7c5c776fa40b58161d4eeb9860f339f0309fafa33">hx711_rate_10</a></div><div class="ttdeci">@ hx711_rate_10</div><div class="ttdef"><b>Definition:</b> <a href="hx711_8h_source.html#l00061">hx711.h:61</a></div></div>
<div class="ttc" id="ahx711_8h_html_acadec7365abc52889994131164536304aa9da6f32e4c6b52bf5c07d6670f942e1"><div class="ttname"><a href="hx711_8h.html#acadec7365abc52889994131164536304aa9da6f32e4c6b52bf5c07d6670f942e1">hx711_gain_128</a></div><div class="ttdeci">@ hx711_gain_128</div><div class="ttdef"><b>Definition:</b> <a href="hx711_8h_source.html#l00071">hx711.h:71</a></div></div>
<div class="ttc" id="ahx711__noblock_8pio_8h_html"><div class="ttname"><a href="hx711__noblock_8pio_8h.html">hx711_noblock.pio.h</a></div></div>
<div class="ttc" id="ahx711__noblock_8pio_8h_html_a116dfe25b456231a2eada965de465101"><div class="ttname"><a href="hx711__noblock_8pio_8h.html#a116dfe25b456231a2eada965de465101">hx711_noblock_program</a></div><div class="ttdeci">static const struct pio_program hx711_noblock_program</div><div class="ttdef"><b>Definition:</b> <a href="hx711__noblock_8pio_8h_source.html#l00024">hx711_noblock.pio.h:42</a></div></div>
<div class="ttc" id="ahx711__noblock_8pio_8h_html_a2a7669554165d3956d65c5f643c022c1"><div class="ttname"><a href="hx711__noblock_8pio_8h.html#a2a7669554165d3956d65c5f643c022c1">hx711_noblock_program_init</a></div><div class="ttdeci">void hx711_noblock_program_init(hx711_t *const hx)</div><div class="ttdef"><b>Definition:</b> <a href="hx711__noblock_8pio_8h_source.html#l00082">hx711_noblock.pio.h:82</a></div></div>
<div class="ttc" id="astructhx711__t_html"><div class="ttname"><a href="structhx711__t.html">hx711_t</a></div><div class="ttdef"><b>Definition:</b> <a href="hx711_8h_source.html#l00076">hx711.h:76</a></div></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md4"></a>
Notes</h1>
<h2><a class="anchor" id="autotoc_md5"></a>
Where is Channel A and Channel B?</h2>
<p>Channel A is selectable by setting the gain to 128 or 64. Channel B is selectable by setting the gain to 32.</p>
<p>The HX711 has no option for Channel A at a gain of 32, nor is there an option for Channel B at a gain of 128 or 64. Similarly, the HX711 is not capable of simultaenously reading from Channel A and Channel B. The gain must first be changed.</p>
<h2><a class="anchor" id="autotoc_md6"></a>
What is hx711_wait_settle?</h2>
<p>After powering up, the HX711 requires a small "settling time" before it can produce "valid stable output data" (see: HX711 datasheet pg. 3). By calling <code><a class="el" href="hx711_8h.html#a5495b51ec048d8363783a572fb577ecc" title="Convenience function for sleeping for the appropriate amount of time according to the given sample ra...">hx711_wait_settle()</a></code> and passing in the correct data rate, you can ensure your program is paused for the correct settling time. Alternatively, you can call <code><a class="el" href="hx711_8h.html#a1bedf171c9de0a547b7fb507227c7cfd" title="Returns the number of milliseconds to wait according to the given HX711 sample rate to allow readings...">hx711_get_settling_time()</a></code> and pass in a <code>hx711_rate_t</code> which will return the number of milliseconds of settling time for the given data rate.</p>
<h2><a class="anchor" id="autotoc_md7"></a>
Save HX711 Gain to Chip</h2>
<p>By setting the HX711 gain with <code>hx711_set_gain</code> and then powering down, the chip saves the gain for when it is powered back up.</p>
<h2><a class="anchor" id="autotoc_md8"></a>
What is hx711_wait_power_down?</h2>
<p>The HX711 requires the clock pin to be held high for at least 60us (60 microseconds) before it powers down. By calling <code><a class="el" href="hx711_8h.html#af76e111ac6776cb7c4321dab53bf8036" title="Convenience function for sleeping for the appropriate amount of time to allow the HX711 to power down...">hx711_wait_power_down()</a></code> after <code><a class="el" href="hx711_8c.html#a8e5d2a3487304a50a4bcf85ecb82ad79">hx711_power_down()</a></code> you can ensure the chip is properly powered-down.</p>
<h2><a class="anchor" id="autotoc_md9"></a>
hx711_close vs hx711_power_down</h2>
<p>In the example code above, the final statement closes communication with the HX711. This leaves the HX711 in a powered-up state. <code>hx711_close</code> stops the internal state machine, whereas <code>hx711_power_down</code> also begins the power down process on the HX711 chip by setting the clock pin high.</p>
<h1><a class="anchor" id="autotoc_md10"></a>
Custom PIO Programs</h1>
<p>You will notice in the code example above that you need to manually include the <code><a class="el" href="hx711__noblock_8pio_8h.html">hx711_noblock.pio.h</a></code> PIO header file. This is because it is not included by default in the <code>hx711-pico-c</code> library. It is offered as a method for reading from the HX711 that I have optimised to run as efficiently as possible. But there is nothing stopping you from creating your own PIO program and using it with the <code><a class="el" href="structhx711__t.html">hx711_t</a></code>. In fact, if you do want to make your own HX711 PIO program, you only need to do the following:</p>
<h2><a class="anchor" id="autotoc_md11"></a>
hx711_init</h2>
<ol type="1">
<li>Pass the <code>pio_program_t*</code> pointer created by <code>pioasm</code> in the Pico SDK (automatically done for you when calling <code>pico_generate_pio_header()</code> in your <code>CMakeLists.txt</code> file).</li>
<li>Pass a function pointer to an initialisation function which sets up the PIO program (but does <em>not</em> start it) which takes a pointer to the <code><a class="el" href="structhx711__t.html">hx711_t</a></code> struct as its only argument. ie. <code>void (*hx711_program_init_t)(hx711_t* const)</code>.</li>
</ol>
<p>The call to <code>hx711_init</code> should look like this:</p>
<div class="fragment"><div class="line"><a class="code" href="hx711_8h.html#a20c562c58345b4cb4c8922925ec0a877">hx711_init</a>(</div>
<div class="line">    &amp;hx,</div>
<div class="line">    clkPin,</div>
<div class="line">    datPin,</div>
<div class="line">    pio0,</div>
<div class="line">    your_pio_program_created_by_pioasm,</div>
<div class="line">    your_pio_initialisation_function);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md12"></a>
Passing HX711 Values From PIO to Code</h2>
<p>The two functions for obtaining values, <code>hx711_get_value</code> and <code>hx711_get_value_timeout</code>, both expect the raw, unsigned value from the HX711 according to the datasheet. There should be 24 bits (ie. 3 bytes) with the most significant bit first.</p>
<p><code>hx711_get_value</code> is a blocking function. It will wait until the RX FIFO is not empty.</p>
<p><code>hx711_get_value_timeout</code> is also a blocking function with a timeout. It will watch the RX FIFO until there are at least 3 bytes.</p>
<p>Both functions will subsequently read from and clear the RX FIFO.</p>
<h2><a class="anchor" id="autotoc_md13"></a>
Setting HX711 Gain</h2>
<p><code>hx711_set_gain</code> will transmit an unsigned 32 bit integer to the PIO program which represents the gain to set. This integer will be in the range 0 to 2 inclusive, corresponding to a HX711 gain of 128, 32, and 64 respectively.</p>
<p>The function will then perform two sequential PIO reads. The first is a non-blocking read to clear whatever is in the RX FIFO, followed by a blocking read to give the PIO program as long as it needs to finish reading the previously set gain.</p>
<h2><a class="anchor" id="autotoc_md14"></a>
Setting HX711 Power</h2>
<p>The PIO program should <em>not</em> attempt to change the HX711's power state. </p>
</div></div><!-- PageDoc -->
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Tue Jan 10 2023 08:56:47 for hx711-pico-c by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
